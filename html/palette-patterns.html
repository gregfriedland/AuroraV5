<!DOCTYPE html>
<html>
<head>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
</head>

<body>
<div id="connectionStatus"></div>
<canvas id="myCanvas" width="1024" height="1000"></canvas>
<script type="text/javascript">

var numColors = 1024;
var numLeds = 104;
var allBaseColors =
[["69D2E7","A7DBD8","E0E4CC","F38630","FA6900"],
["FE4365","FC9D9A","F9CDAD","C8C8A9","83AF9B"],
["ECD078","D95B43","C02942","542437","53777A"],
["556270","4ECDC4","C7F464","FF6B6B","C44D58"],
["774F38","E08E79","F1D4AF","ECE5CE","C5E0DC"],
["E8DDCB","CDB380","036564","033649","031634"],
["490A3D","BD1550","E97F02","F8CA00","8A9B0F"],
["594F4F","547980","45ADA8","9DE0AD","E5FCC2"],
["00A0B0","6A4A3C","CC333F","EB6841","EDC951"],
["E94E77","D68189","C6A49A","C6E5D9","F4EAD5"],
["D9CEB2","948C75","D5DED9","7A6A53","99B2B7"],
["FFFFFF","CBE86B","F2E9E1","1C140D","CBE86B"],
["EFFFCD","DCE9BE","555152","2E2633","99173C"],
["3FB8AF","7FC7AF","DAD8A7","FF9E9D","FF3D7F"],
["413E4A","73626E","B38184","F0B49E","F7E4BE"],
["343838","005F6B","008C9E","00B4CC","00DFFC"],
["99B898","FECEA8","FF847C","E84A5F","2A363B"],
["554236","F77825","D3CE3D","F1EFA5","60B99A"],
["FF4E50","FC913A","F9D423","EDE574","E1F5C4"],
["351330","424254","64908A","E8CAA4","CC2A41"],
["FF4242","F4FAD2","D4EE5E","E1EDB9","F0F2EB"],
["00A8C6","40C0CB","F9F2E7","AEE239","8FBE00"],
["8C2318","5E8C6A","88A65E","BFB35A","F2C45A"],
["FAD089","FF9C5B","F5634A","ED303C","3B8183"],
["BCBDAC","CFBE27","F27435","F02475","3B2D38"],
["655643","80BCA3","F6F7BD","E6AC27","BF4D28"],
["D1E751","FFFFFF","000000","4DBCE9","26ADE4"],
["5D4157","838689","A8CABA","CAD7B2","EBE3AA"],
["FF9900","424242","E9E9E9","BCBCBC","3299BB"],
["5E412F","FCEBB6","78C0A8","F07818","F0A830"],
["EEE6AB","C5BC8E","696758","45484B","36393B"],
["1B676B","519548","88C425","BEF202","EAFDE6"],
["F8B195","F67280","C06C84","6C5B7B","355C7D"],
["452632","91204D","E4844A","E8BF56","E2F7CE"],
["F04155","FF823A","F2F26F","FFF7BD","95CFB7"],
["F0D8A8","3D1C00","86B8B1","F2D694","FA2A00"],
["2A044A","0B2E59","0D6759","7AB317","A0C55F"],
["67917A","170409","B8AF03","CCBF82","E33258"],
["B9D7D9","668284","2A2829","493736","7B3B3B"],
["BBBB88","CCC68D","EEDD99","EEC290","EEAA88"],
["A3A948","EDB92E","F85931","CE1836","009989"],
["E8D5B7","0E2430","FC3A51","F5B349","E8D5B9"],
["B3CC57","ECF081","FFBE40","EF746F","AB3E5B"],
["AB526B","BCA297","C5CEAE","F0E2A4","F4EBC3"],
["3E4147","FFFEDF","DFBA69","5A2E2E","2A2C31"],
["607848","789048","C0D860","F0F0D8","604848"],
["515151","FFFFFF","00B4FF","EEEEEE"],
["1C2130","028F76","B3E099","FFEAAD","D14334"],
["EDEBE6","D6E1C7","94C7B6","403B33","D3643B"],
["A8E6CE","DCEDC2","FFD3B5","FFAAA6","FF8C94"],
["300030","480048","601848","C04848","F07241"],
["FDF1CC","C6D6B8","987F69","E3AD40","FCD036"],
["AAB3AB","C4CBB7","EBEFC9","EEE0B7","E8CAAF"],
["3A111C","574951","83988E","BCDEA5","E6F9BC"],
["CC0C39","E6781E","C8CF02","F8FCC1","1693A7"],
["5E3929","CD8C52","B7D1A3","DEE8BE","FCF7D3"],
["FC354C","29221F","13747D","0ABFBC","FCF7C5"],
["B9D3B0","81BDA4","B28774","F88F79","F6AA93"],
["230F2B","F21D41","EBEBBC","BCE3C5","82B3AE"],
["4E395D","827085","8EBE94","CCFC8E","DC5B3E"],
["5C323E","A82743","E15E32","C0D23E","E5F04C"],
["C2412D","D1AA34","A7A844","A46583","5A1E4A"],
["D1313D","E5625C","F9BF76","8EB2C5","615375"],
["9D7E79","CCAC95","9A947C","748B83","5B756C"],
["DAD6CA","1BB0CE","4F8699","6A5E72","563444"],
["5B527F","9A8194","C6A9A3","EBD8B7","99BBAD"],
["75616B","BFCFF7","DCE4F7","F8F3BF","D34017"],
["CFFFDD","B4DEC1","5C5863","A85163","FF1F4C"],
["1C0113","6B0103","A30006","C21A01","F03C02"],
["9DC9AC","FFFEC7","F56218","FF9D2E","919167"],
["8DCCAD","988864","FEA6A2","F9D6AC","FFE9AF"],
["382F32","FFEAF2","FCD9E5","FBC5D8","F1396D"],
["EDF6EE","D1C089","B3204D","412E28","151101"],
["7E5686","A5AAD9","E8F9A2","F8A13F","BA3C3D"],
["E3DFBA","C8D6BF","93CCC6","6CBDB5","1A1F1E"],
["413D3D","040004","C8FF00","FA023C","4B000F"],
["A7C5BD","E5DDCB","EB7B59","CF4647","524656"],
["A8A7A7","CC527A","E8175D","474747","363636"],
["B6D8C0","C8D9BF","DADABD","ECDBBC","FEDCBA"],
["FFEDBF","F7803C","F54828","2E0D23","F8E4C1"],
["C1B398","605951","FBEEC2","61A6AB","ACCEC0"],
["5E9FA3","DCD1B4","FAB87F","F87E7B","B05574"],
["951F2B","F5F4D7","E0DFB1","A5A36C","535233"],
["9CDDC8","BFD8AD","DDD9AB","F7AF63","633D2E"],
["84B295","ECCF8D","BB8138","AC2005","2C1507"],
["FFFBB7","A6F6AF","66B6AB","5B7C8D","4F2958"],
["000000","9F111B","B11623","292C37","CCCCCC"],
["EFF3CD","B2D5BA","61ADA0","248F8D","605063"],
["B5AC01","ECBA09","E86E1C","D41E45","1B1521"],
["FCFEF5","E9FFE1","CDCFB7","D6E6C3","FAFBE3"],
["4D3B3B","DE6262","FFB88C","FFD0B3","F5E0D3"],
["0CA5B0","4E3F30","FEFEEB","F8F4E4","A5B3AA"],
["379F7A","78AE62","BBB749","E0FBAC","1F1C0D"],
["793A57","4D3339","8C873E","D1C5A5","A38A5F"],
["FFE181","EEE9E5","FAD3B2","FFBA7F","FF9C97"],
["11766D","410936","A40B54","E46F0A","F0B300"],
["4E4D4A","353432","94BA65","2790B0","2B4E72"],
["F38A8A","55443D","A0CAB5","CDE9CA","F1EDD0"],
["A70267","F10C49","FB6B41","F6D86B","339194"],
["30261C","403831","36544F","1F5F61","0B8185"]];



function getWaitTime(val, min, max) {
  var expBase = Math.pow(Math.pow(10, Math.log(max-min)), 1/255.0);
  
  return min + Math.pow(expBase, val);
}



function Palette(index, baseColors, numColors) {
  this.index = index;
  this.baseColors = baseColors;
  this.rgbs = this.getGradient(baseColors, numColors);
  this.numColors = numColors;
}

Palette.prototype.getGradient = function(colors, length) {
  var canvas = document.createElement('canvas');
  canvas.width = length;
  canvas.height = 1;
  var context = canvas.getContext('2d');

  var gradient = context.createLinearGradient(0, 0, length, 1);
  for (var i=0; i<colors.length; i++) {
    gradient.addColorStop(i/colors.length, "#" + colors[i]);
  }
  gradient.addColorStop(1.0, "#" + colors[0]);

  context.fillStyle = gradient;
  context.fillRect(0, 0, length, 1);  
  var imageData = context.getImageData(0, 0, length, 1).data;
  var rgbs = [];
  for (var i=0; i<length; i++) {
    rgbs.push([imageData[i*4], imageData[i*4+1], imageData[i*4+2]]);
  }
  return rgbs;
}



function PaletteManager(allBaseColors, numColors) {
  this.numColors = numColors;
  this.palettes = [];
  for (var i=0; i<allBaseColors.length; i++) {
    this.palettes.push(new Palette(i, allBaseColors[i], numColors));
  }
  this.currPalette = Math.floor(Math.random() * allBaseColors.length);
}

PaletteManager.prototype.getCurrent = function() {
  return this.palettes[this.currPalette];
}

PaletteManager.prototype.setCurrentIndex = function(i) {
  this.currPalette = i % this.palettes.length;
}



// Set all pixels to a given color
function updateLEDs(socket, leds) {
  var packet = new Uint8ClampedArray(4 + leds.length * 3);

  if (socket.readyState != 1 /* OPEN */) {
      console.log("Fadecandy server not open");
      // The server connection isn't open. Nothing to do.
      return;
  }

  if (socket.bufferedAmount > packet.length) {
      console.log("Fadecandy server connection problems");
      // The network is lagging, and we still haven't sent the previous frame.
      // Don't flood the network, it will just make us laggy.
      // If fcserver is running on the same computer, it should always be able
      // to keep up with the frames we send, so we shouldn't reach this point.
      return;
  }

  // Sample the center pixel of each LED
  var dest = 4; // Dest position in our packet. Start right after the header.
  for (var i = 0; i < leds.length; i++) {
      packet[dest++] = leds[i][0];
      packet[dest++] = leds[i][1];
      packet[dest++] = leds[i][2];
  }
  socket.send(packet.buffer);
}



function Animator(numLeds, allBaseColors, numColors, updateLEDsFunc) {
  this.leds = [];
  for (var i=0; i<numLeds; i++) {
    this.leds.push([0,0,0]);
  }
  
  this.paletteMgr = new PaletteManager(allBaseColors, numColors);
  this.updateLEDsFunc = updateLEDsFunc;
}

Animator.prototype.run = function(func, config, state) {
  var newState = func(this.leds, this.updateLEDsFunc, this.paletteMgr.getCurrent(), config, state);
  
  var anim = this;
  setTimeout(function() { anim.run(func, config, newState); },
             newState.delay);
}

//// draw gradients to a canvas
//var canvas = document.getElementById('myCanvas');
//var context = canvas.getContext('2d');
//  
//for (var i = 0; i < paletteMgr.palettes.length; i++) {
//  var rgbs = paletteMgr.palettes[i].rgbs;
//  for (var j=0; j < rgbs.length; j++) {
//    context.fillStyle = 'rgb(' + rgbs[j][0] + ',' + rgbs[j][1] + ',' + rgbs[j][2] + ')';
//    context.fillRect(j, i*10, 1, 10);
//  }
//}



function RotateGradient(leds, updateLEDsFunc, palette, config, state) {
  for (var l=0; l<leds.length; l++) {
    var rgb = palette.rgbs[Math.floor(((state.t + l) % leds.length) * palette.numColors / leds.length)];
    leds[l] = rgb;
  }

  updateLEDsFunc(leds);
  
  state.t = (state.t + 1) % leds.length;
  state.delay = 1000/getWaitTime(config.wait, config.waitRange[0], config.waitRange[1]);
  return state;
}



// Connect to a Fadecandy server running on the same computer, on the default port
// Put some connection status text in the corner of the screen
var socket = new WebSocket('ws://10.0.1.77:7890');
$('#connectionStatus').text('Connecting to fcserver...');
socket.onclose = function(event) {
    $('#connectionStatus').text('Not connected to fcserver');
}
socket.onopen = function(event) {
    $('#connectionStatus').text('Connected');
    
    var anim = new Animator(numLeds, allBaseColors, numColors,
                                 function(leds) { updateLEDs(socket, leds); });
    anim.run(RotateGradient, { waitRange:[5,50], wait:70 }, { t:0 });
}



</script>
</body>
</html>
